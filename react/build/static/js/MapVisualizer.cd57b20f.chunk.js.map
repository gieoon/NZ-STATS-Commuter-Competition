{"version":3,"sources":["components/leafletMap.jsx","components/mapVisualizer.jsx"],"names":["commuteWorkCurves","commuteEducationCurves","currentSelectedCurve","LeafletMap","setHoveredData","setHighlightedData","currentMap","centroidData","currentCommuteTypes","setCurrentDestinationData","setClickedData","mapRef","position","topLeft","L","latLng","bottomRight","useState","useRef","left","top","right","bottom","setLastRequestedLatLng","commutePurpose","setCommutePurpose","lat","lng","zoom","searchUpdatedLocation","setSearchUpdatedLocation","setInitializing","location","useLocation","history","useHistory","useEffect","control","scale","addTo","current","leafletElement","updateData","match","pathname","length","split","z","setView","option","toUpperCase","commuteType","clearDrawnObjectsCommute","off","on","updateDataAndCentroids","from","to","map","bounds","getBounds","center","getCenter","getZoom","replace","API_zoneData","updateCurrentSelectedCurve","obj","Object","keys","remove","createCurve","Number","departure_LONGITUDE","departure_LATITUDE","destination_LONGITUDE","destination_LATITUDE","key2CommuteType","key","type","a","async","_northEast","_southWest","commuteTypes","commute_type","fetch","DATA_URL_ROOT","toLowerCase","then","d","json","data","updateCurvesCommute","catch","err","console","error","dataType","curvesToAdd","checkCurvesExistCommute","r","curve","id","newData","toAdd","toDelete","txt2Array","push","Array","document","getElementsByClassName","el","classList","add","undefined","checkCurveMemorySize","values","lon1","lat1","lon2","lat2","b_currentSelectedCurve","includes","COMMUTE_TYPE","lon","circleCenter","radius","COUNT","circle","color","fillColor","fillOpacity","e","createStayAtHomePopup","SA2_name_usual_residence_address","SA2_name_workplace_address","closePopup","createStayAtHomeCircle","delta_x","delta_y","Math","sqrt","pow","theta","atan2","r2","cos","theta2","midpointX","midpointLatLng","sin","pathOptions","COMMUTE_METHOD_COLOUR","DB_2_COMMUTE_METHOD","weight","INITIAL_STROKE_WEIGHT","opacity","this","setStyle","hoveredData","hoveredDestination","destination_SA22018_V1_NAME","createPopup","_path","popup","closeButton","autoPan","setLatLng","latlng","setContent","DEPARTURE_NAME_1","DESTINATION_NAME_1","SA2_name_educational_address","HAVERSINE_DISTANCE","toFixed","TYPE","openOn","Map","ref","zoomControl","maxBounds","latLngBounds","minZoom","maxZoom","layers","TileLayer","url","attribution","getTotalStatistic","statistic","colorInterpolator","confirmed","t","interpolateReds","active","interpolateBlues","recovered","interpolateGreens","deceased","interpolateGreys","tested","interpolatePurples","MapVisualizer","regionalEducationData","regionalWorkData","regionalTotalData","setRegionalData","currentView","setCurrentView","changeMap","regionHighlighted","setRegionHighlighted","isCountryLoaded","svgRef","useTranslation","mapMeta","MAP_META","geoData","useSWR","geoDataFile","file","revalidateOnFocus","suspense","statisticMax","useMemo","districtCodes","filter","districtCode","view","MAP_TYPES","COUNTRY","max","MAP_OPTIONS","PER_MILLION","DISTRICT_POPULATIONS_MIL","districts","districtData","statisticTotal","code","mapScale","ZONES","scaleOrdinal","ZONE_COLORS","HOTSPOTS","scaleSqrt","clamp","nice","scaleSequential","topology","topojson","objects","graphObjectStates","graphObjectDistricts","svg","select","projection","geoMercator","fitSize","path","geoPath","features","DISTRICT","mapType","f","assign","properties","HASC_2","n","CITY_CODES","NAME_1","city","NAME_2","cityData","zone","strokeColor","initialFillColor","transition","duration","D3_TRANSITION_DURATION","onceTouchedRegion","selectAll","join","enter","sel","append","attr","REGION_STROKE_WIDTH","style","cityName","districtName","TOTAL","WORK","EDUCATION","getRegionalData","update","call","event","stopPropagation","x","y","k","centered","centroid","width","height","classed","districtClicked","text","district","capitalizeAll","forEach","Red","COLORS","MAP_STROKE_WIDTH","coordDepart","coordArrivee","coordinates","geoContains","log","MAP_CIRCLE_RADIUS","meshCountry","CITY_NAMES","each","highlighted","parentNode","appendChild","Fragment"],"mappings":"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","file":"static/js/MapVisualizer.cd57b20f.chunk.js","sourcesContent":["import React, {\n    useState, \n    useMemo, \n    useEffect, \n    useRef, \n    forwardRef,\n    useImperativeHandle // Child only exposes certain properties to parent.\n} from 'react';\nimport { Map, Marker, Popup, TileLayer } from 'react-leaflet';\nimport {useLocation, useHistory} from 'react-router-dom';\nimport L, { circle } from 'leaflet';\nimport '@elfalem/leaflet-curve'\nimport './leaflet.scss'; // as opposed to .scss file which is CSS-like, or .sass which is considered SASS\nimport {\n    DATA_URL_ROOT,\n    COMMUTE_METHOD_COLOUR,\n    DB_2_COMMUTE_METHOD,\n} from '../constants';\nimport {\n    txt2Array\n} from '../utils/commonFunctions';\n// import { divIcon } from 'leaflet';\n// import DivIcon from 'react-leaflet-div-icon';\n// import arrow_right from '../assets/right.svg';\n// import MarkerClusterGroup from \"react-leaflet-markercluster\";\n\nconst MIN_ZOOM = 5;\nconst MAX_ZOOM = 18;\nconst INITIAL_STROKE_WEIGHT = 1;\nconst HIGHLIGHTED_STROKE_WEIGHT = INITIAL_STROKE_WEIGHT * 3.5;\nconst STROKE_COUNT_MULTIPLIER = 0.1;\nconst INITIAL_OPACITY = .75;//0.35;\nconst OPACITY_MULTIPLIER = 0.01;\nconst HIGHLIGHTED_OPACITY = 1;\n\nconst curvesWork = {}, \n    curvesEducation = {},\n    commuteWorkCurves = {},\n    commuteEducationCurves = {};\n\n// The curve that is currently selected on the map.    \nvar currentSelectedCurve = {};\n\n// Allows for console debugging by calling >> curves in Chrome\n// global.commuteWorkCurves = commuteWorkCurves; \n// global.commuteEducationCurves = commuteEducationCurves;\n\n//forwardRef(\n    function LeafletMap({\n    setHoveredData,\n    setHighlightedData,\n    centroidData,\n    currentMap,\n    currentCommuteTypes,\n    setCurrentDestinationData,\n    setClickedData,\n    mapRef,\n}){\n    \n\n    // Center of New Zealand\n    // const position = [173.299, -41.273]\n    const position = [-41.273, 173.299]\n    const topLeft = L.latLng(-31.154944, 150.138842); //162\n    const bottomRight = L.latLng(-49.285522, 191.794907); // 179\n    // console.log('centroidData: ', centroidData);\n    // const [curvesWork, setCurvesWork] = useState({});\n    // const [curvesEducation, setCurvesEducation] = useState({});\n\n    const [circles, setCircles] = useState([]);\n\n    // const mapRef = React.createRef();\n    // const mapRef = useRef(null);\n\n    const isInitialMount = useRef(true);\n\n    // Need to save this because it becomes null after updates\n    const [m, setMap] = useState();\n\n    // The variables that we last requested from server, only request again if these have changed\n    const [lastRequestedLatLng, setLastRequestedLatLng] = useState({\n       left: 0,//162.138842,\n       top: 0,//-31.15494,\n       right: 0,//179.794907,\n       bottom: 0,//-49.285522, \n    });\n\n    // Data for zoom & boundary\n    const [workZoneData, setWorkZoneData] = useState([]);\n\n    const [educationZoneData, setEducationZoneData] = useState([]);\n\n    const [commutePurpose, setCommutePurpose] = useState(\"TOTAL\");\n\n    const [currentLatLng, setCurrentLatLng] = useState({\n        lat: position[0],\n        lng: position[1],\n        zoom: MIN_ZOOM,\n    })\n\n    const [searchUpdatedLocation, setSearchUpdatedLocation] = useState(false);\n\n    // Circle highlighting current selection on the map\n    const [currentPositionCircle, setCurrentPositionCircle] = useState(null);\n\n    const [initializing, setInitializing] = useState(true);\n\n    const location = useLocation();\n    const history = useHistory();\n\n    // useImperativeHandle(ref, () => {\n    //     return {\n    //         updateData: updateData()\n    //     }\n    // });\n\n    // componentDidMount\n    useEffect(()=>{\n        L.control.scale().addTo(mapRef.current.leafletElement);\n\n        // To make this function accessible from search\n        // console.log(updateData);\n        mapRef.current.leafletElement.updateData = updateData;\n    },[])\n\n    // useEffect(()=>{\n    //     if(isInitialMount.current)\n    //         isInitialMount.current = false;\n    //     else {\n    //         // console.log('update data called');\n    //         updateData();\n    //     }\n    //     console.log(currentCommuteTypes)\n    // }, [currentCommuteTypes])\n\n    useEffect(()=>{\n        // console.log('location changed: ', location.pathname)\n        var reg = /[\\-0-9.]+\\/[\\-0-9.]+\\/[\\-0-9.]+$/;\n        // console.log(location.pathname)\n        var match = location.pathname.match(reg);\n        // console.log(match);\n        if(match && match.length){\n            var lat = match[0].split('/')[0];\n            var lng = match[0].split('/')[1];\n            var z = match[0].split('/')[2];\n            // console.log(\"Location updated: \", match, lat, lng, z);\n            // console.log(\"searchUpdatedLocation: \", searchUpdatedLocation);\n            // Zoom into this location, but not the first time\n            if(\n                searchUpdatedLocation\n                // currentLatLng.lat !== lat\n                // || currentLatLng.lng !== lng\n                // || currentLatLng.zoom !== z\n            ){\n                mapRef.current.leafletElement.setView([lat,lng], z); //9\n                // var circle = createCurrentLatLngCircle(lat, lng);\n                // setCurrentPositionCircle(circle);\n                // console.log('update data called');\n                updateData();\n                \n                setSearchUpdatedLocation(true);\n\n            }\n            setInitializing(false);\n        }\n    }, [location])\n\n    useEffect(() => {\n        setCommutePurpose(currentMap.option.toUpperCase());\n        mapRef.current.leafletElement.commuteType = currentMap.option.toUpperCase();\n        /*\n        clearDrawnObjects(\n            currentMap.option.toUpperCase() === \"WORK\"\n            ? curvesEducation\n            : curvesWork,\n            currentMap.option.toUpperCase() === \"WORK\"\n            ? \"EDUCATION\"\n            : \"WORK\"\n        );\n        */\n       clearDrawnObjectsCommute(\n           currentMap.option.toUpperCase() === \"WORK\"\n           ? commuteEducationCurves\n           : commuteWorkCurves,\n           currentMap.option.toUpperCase() === \"WORK\"\n           ? \"EDUCATION\"\n           : \"WORK\"\n       )\n    }, [\n        currentMap.option,\n    ])\n\n    useEffect(() => {\n        // Listen when bounds change so we can load different data\n        // Disable current listeners\n        mapRef.current.leafletElement.off('movestart');\n        mapRef.current.leafletElement.on('movestart', updateData);\n\n        // mapRef.current.leafletElement.off('moveend');\n        // mapRef.current.leafletElement.on('moveend', updateData);\n\n\n        // mapRef.current.leafletElement.off('viewreset');\n        // mapRef.current.leafletElement.on('viewreset', updateData);\n\n        // mapRef.current.leafletElement.off('zoomstart');\n        // mapRef.current.leafletElement.on('zoomstart', updateDataAndCentroids);\n        mapRef.current.leafletElement.off('zoomend');\n        mapRef.current.leafletElement.on('zoomend', updateDataAndCentroids);\n        // console.log('update data called');\n        updateDataAndCentroids();\n        \n        \n    },[\n        commutePurpose,\n        currentCommuteTypes\n    ])\n\n    const updateDataAndCentroids = () => {\n        updateData();\n        // updateCentroids();\n    }\n\n    const updateData = () => {\n        setClickedData({});\n        setCurrentDestinationData({\n            from: \"\",\n            to: \"\"\n        })\n        \n\n        const map = mapRef.current.leafletElement;\n        var bounds = map.getBounds();\n        var center = bounds.getCenter();\n            // {\n            //     lat: currentLatLng.lat,\n            //     lng: currentLatLng.lng,\n            //     zoom: currentLatLng.zoom\n            // };\n        var zoom = map.getZoom();\n        // console.log(center);\n        // Update URL\n        // setCurrentLatLng({\n        //     lat: center.lat,\n        //     lng: center.lng,\n        //     zoom: zoom,\n        // });\n        // console.log('history: ', history);\n        history.replace(`/location/${center.lat}/${center.lng}/${zoom}`)\n\n        // console.log('requesting data with zoom: ', zoom);\n        // If total, request both data types\n        // Can also do if !== education, request work, if !== work, request education, so total will request both.\n        if(commutePurpose === \"TOTAL\"){\n            API_zoneData(bounds, zoom, \"EDUCATION\");\n            API_zoneData(bounds, zoom, \"WORK\");\n        } else {\n            // Otherwise just search directly\n            API_zoneData(bounds, zoom, commutePurpose);\n        }\n\n        // Circle information\n        //TODO add this back in\n        /*\n        for(var c of centroidData[zoom]){\n            createCircle(c.departure_LATITUDE, c.departure_LONGITUDE, c.cluster_count);\n        }\n        */\n        \n        \n    }\n/*\n    const updateCentroids = () => {\n        // return; //TODO NO ACTION FOR NOW\n        if(!centroidData) \n            return;\n        circles.forEach(circle => {\n            console.log('deleting circle')\n            circle.remove();\n        })\n        var ci = circles;\n        ci.length = 0;\n        setCircles(ci);\n\n        // Load data for current centroids\n        var zoom = mapRef.current.leafletElement.getZoom();\n\n        for(var commuteMethod of currentCommuteTypes){\n            //TODO this is hardcoded to 'work' for now\n            var data = centroidData[`${\"work\"}_${commuteType2Key(commuteMethod)}_${zoom}`]\n            console.log('data to draw: ',data);\n            for(var c of data){\n                createCircle(c.departure_LATITUDE, c.departure_LONGITUDE, c.cluster_count, commuteMethod, MAX_ZOOM - zoom);\n            }\n        }\n        \n    }\n*/\n    const updateCurrentSelectedCurve = (obj) => {\n        \n        if(Object.keys(currentSelectedCurve).length){\n            // console.log('removing current selected curve')\n            currentSelectedCurve.remove();\n        }\n        currentSelectedCurve = createCurve(\n            Number(obj.departure_LONGITUDE), \n            Number(obj.departure_LATITUDE), \n            Number(obj.destination_LONGITUDE), \n            Number(obj.destination_LATITUDE),\n            obj,\n            true\n        );\n    }\n\n    // console.log(\"centroidData: \", centroidData)\n\n    const commuteType2Key = (commute_type) => {\n        if(commute_type === \"Stay home\")\n            return \"home\"\n        else if(commute_type === \"Drive own vehicle\")\n            return \"own_vehicle\"\n        else if(commute_type === \"Passenger in vehicle\")\n            return \"passenger\"\n        else if(commute_type === \"Train\")\n            return \"train\"\n        else if(commute_type === \"Bicycle\")\n            return \"bicycle\"\n        else if(commute_type === \"Walk or jog\")\n            return \"walk_or_jog\"\n        else if(commute_type === \"Bus\")\n            return \"bus\"\n        else if(commute_type === \"Ferry\")\n            return \"ferry\"\n        else if(commute_type === \"Ferry\" || commute_type === \"Other\")\n            return \"other\";\n        else\n            return commute_type\n    }\n\n    const key2CommuteType = (key) => {\n        switch(key){\n            case \"WORK_AT_HOME\": \n            case \"STUDY_AT_HOME\":\n                return \"Working/Studying from Home\";\n            case \"DRIVE_OWN_VEHICLE\": return \"Driving own vehicle\";\n            case \"PASSENGER_IN_VEHICLE\": return \"Passenger in vehicle (car/truck/van)\";\n            case \"TRAIN\": return \"Train\";\n            case \"BICYCLE\": return \"Bicycle\";\n            case \"WALK_OR_JOG\": return \"Walking/Jogging\";\n            case \"BUS\": return \"Bus\";\n            case \"FERRY\": return \"Ferry\";\n            case \"OTHER\": return \"Other\";\n            default: return \"Other\";\n        }\n    }\n\n    const API_zoneData = async (bounds, zoom, type) => {\n        // console.log('requesting data with type: ', type);\n        // if(\n        //        lastRequestedLatLng.top      !== bounds._northEast.lat\n        //     && lastRequestedLatLng.bottom   !== bounds._southWest.lat\n        //     && lastRequestedLatLng.left     !== bounds._southWest.lng\n        //     && lastRequestedLatLng.right    !== bounds._northEast.lng\n        // ){\n            setLastRequestedLatLng({\n                top: bounds._northEast.lat,\n                bottom: bounds._southWest.lat,\n                left: bounds._southWest.lng,\n                right: bounds._northEast.lng,\n            });\n            var commuteTypes = \"\";\n            for(var commuteType of currentCommuteTypes){\n                commuteTypes += \"&commute_type=\" + commuteType2Key(commuteType);\n            }\n\n            // console.log(\"currentCommuteTypes: \", currentCommuteTypes)\n            // Request new data\n            fetch(\n                DATA_URL_ROOT + `/zoneData?left=${bounds._southWest.lng}&top=${bounds._northEast.lat}&right=${bounds._northEast.lng}&bottom=${bounds._southWest.lat}&zoom=${zoom}&data_type=${type.toLowerCase()}${commuteTypes}`,\n            ).then(async (d)=>{\n                const data = await d.json();\n                if(type === \"WORK\"){\n                    // setWorkZoneData(data);\n                    updateCurvesCommute(data, \"WORK\");\n                }\n                if(type === \"EDUCATION\"){\n                    // setEducationZoneData(data);\n                    updateCurvesCommute(data, \"EDUCATION\");\n                }\n            })\n            .catch(err => {\n                console.error(\"Error fetching data: \", err);\n            })\n        // }\n    }\n\n    const updateCurvesCommute = (d, dataType) => {\n        if(!d) return;\n        var curvesToAdd = checkCurvesExistCommute(d, dataType);\n        for(var commuteType of Object.keys(curvesToAdd)){\n            for(var r of curvesToAdd[commuteType]){\n                const curve = createCurve(\n                    Number(r.departure_LONGITUDE), \n                    Number(r.departure_LATITUDE), \n                    Number(r.destination_LONGITUDE), \n                    Number(r.destination_LATITUDE),\n                    r,\n                    false\n                );\n                if(dataType === \"WORK\"){\n                    if(!commuteWorkCurves[commuteType])\n                        commuteWorkCurves[commuteType] = {};\n                    commuteWorkCurves[commuteType][r.id] = curve;\n                }\n                else if(dataType === \"EDUCATION\"){\n                    if(!commuteEducationCurves[commuteType])\n                        commuteEducationCurves[commuteType] = {};\n                    commuteEducationCurves[commuteType][r.id] = curve;\n                }\n            }\n        }\n    }\n\n    const updateCurves = (d, dataType) =>{\n        if(!d) return;\n        var curvesToAdd = checkCurvesExist(d, dataType); //checkCurvesExist(d, dataType);\n        for(var r of curvesToAdd){\n            const curve = createCurve(\n                Number(r.departure_LONGITUDE), \n                Number(r.departure_LATITUDE), \n                Number(r.destination_LONGITUDE), \n                Number(r.destination_LATITUDE),\n                r,\n                false\n            );\n            if(dataType === \"WORK\"){\n                curvesWork[r.id] = curve;\n            }\n            else if(dataType === \"EDUCATION\"){\n                curvesEducation[r.id] = curve;\n            }\n        }\n    }\n\n    const checkCurvesExistCommute = (newData, dataType) => {\n        var toAdd = {};\n        // What is actually drawn on the screen right now\n        const toDelete = dataType === \"WORK\" \n        ? commuteWorkCurves : commuteEducationCurves;\n        \n        // console.log(\"newData: \", newData);\n        // global.newData = newData;\n        // console.log(\"newData: \", Object.keys(newData));\n        for(var commuteType of Object.keys(newData)){\n            // console.log('handling commuteType: ', commuteType, newData[commuteType]);\n            toAdd[commuteType] = [];\n            var d = txt2Array(newData[commuteType])\n            // console.log(commuteType, d);\n            for(var r of d){\n                // If new curve is not in existing curves, add it to list of new curves\n                if(!toDelete[r.id]){\n                    toAdd[commuteType].push(r);\n                }\n            }\n    \n        }\n        clearDrawnObjectsCommute(toDelete, dataType);\n\n        return toAdd;\n    }\n\n    // Checks if the curve is already drawn on the map, if it is, exclude it.\n    // Returns the new curves to add to the map\n    const checkCurvesExist = (newData, dataType) => {\n        // Dictionary of row id;\n        var toAdd = [];\n        const toDelete = (dataType === \"WORK\" ? curvesWork : curvesEducation);\n\n        // If too many curves, don't show everything.\n\n        // If the new curve is not in the existing curves, remove it.\n\n        for(var r of newData){\n            // If new curve is not in existing curves, add it to list of new curves\n            if(!toDelete[r.id]){\n                toAdd.push(r);\n            }\n            // If new curve is in existing curves, it means it is already drawn, \n            // delete it from the toRemove dictionary\n            if(toDelete[r.id]){\n                // toDelete[r.id] = undefined;\n                // delete toDelete[r.id];\n            }\n            // If commute purpose is education, and key starts with 'E'\n            // Delete until proven otherwise.\n            // if((dataType === \"EDUCATION\" && commutePurpose !== \"TOTAL\") && r.id.substring(0,1) === 'W'){\n                // toDelete[r.id] = undefined;\n                // delete toDelete[r.id];\n            // }\n            // if((dataType === \"WORK\" && commutePurpose !== \"TOTAL\") && r.id.substring(0, 1) === 'E') {\n                // toDelete[r.id] = undefined;\n                // delete toDelete[r.id];\n            // }\n            \n            // Otherwise leave it in the array to be removed as it no longer should be drawn\n        }\n\n        // console.log(\"actually removing: \", Object.keys(toDelete).length);\n\n        // clearDrawnObjects(toDelete, dataType);\n\n        return toAdd;\n    }\n    \n    const clearDrawnObjectsCommute = (toDelete, dataType) => {\n        \n        for(var commuteType of Object.keys(toDelete)){\n            \n            for(var id of Object.keys(toDelete[commuteType])){\n                for(var el of Array.from(document.getElementsByClassName(id))){\n                    if(el){\n                        // console.log('removing curve from DOM');\n                        el.classList.remove('pathFadeIn');\n                        el.classList.add('pathFadeOut');\n                        // Wait for animation to expire and remove from DOM\n                        el.remove();\n                    }\n                }\n                if(dataType === \"WORK\"){\n                    // console.log(\"removing curve from memory\");\n                    commuteWorkCurves[commuteType][id].remove();\n                    commuteWorkCurves[commuteType][id] = undefined;\n                    delete commuteWorkCurves[commuteType][id];\n                }\n                else if(dataType === \"EDUCATION\"){\n                    // console.log(\"removing curve from memory\");\n                    commuteEducationCurves[commuteType][id].remove();\n                    commuteEducationCurves[commuteType][id] = undefined;\n                    delete commuteEducationCurves[commuteType][id];\n                }\n            }\n        }\n\n        checkCurveMemorySize();\n        \n    }\n\n    // Disable on production\n    const checkCurveMemorySize = () => {\n        var totalWork = 0, totalEducation = 0;\n        for(var commuteType of Object.values(commuteWorkCurves)){\n            totalWork += Object.keys(commuteType).length;\n        }\n        for(var commuteType of Object.values(commuteEducationCurves)){\n            totalEducation += Object.keys(commuteType).length;\n        }\n        // console.log(\"total work: \", totalWork)\n        // console.log(\"total education: \", totalEducation);\n    }\n\n    /*\n    const clearDrawnObjects = (toDelete, dataType) => {\n        // console.log(\"deleting data: \", Object.keys(toDelete).length);\n        // console.log(curvesWork);\n        // console.log(curvesEducation);\n        for(var id of Object.keys(toDelete)){\n            // var el = document.getElementById(id);\n            for(var el of Array.from(document.getElementsByClassName(id))){\n                if(el){\n                    el.classList.remove('pathFadeIn');\n                    el.classList.add('pathFadeOut');\n                    // Wait for animation to expire and remove from DOM\n                    el.remove();\n                }\n            }\n            if(dataType === \"WORK\"){\n                curvesWork[id].remove();\n                curvesWork[id] = undefined;\n                delete curvesWork[id];\n            }\n            else if(dataType === \"EDUCATION\"){\n                curvesEducation[id].remove();\n                curvesEducation[id] = undefined;\n                delete curvesEducation[id];\n            }\n        };\n\n        // toRemove = {};\n        // var c = curves;\n        // c.length = 0;\n        // console.log(\"current curves: \", curves);\n        // setCurves(curves);\n\n        circles.forEach(circle => {\n            circle.remove();\n        })\n        var ci = circles;\n        ci.length = 0;\n        setCircles(ci);\n    }\n    */\n\n    const createStayAtHomeCircle = (lat, lon, obj) => {\n        // console.log('creating stay at home data');\n        var circleCenter = [lat, lon];\n        var options = {\n            // weight: 1.5,\n            color: 'rgba(0,0,0,0)',\n            fillColor: '#f54242',\n            fillOpacity: 0.7,\n        }\n        var radius = Number(obj.COUNT) * .1 + 2;\n        radius *= (MAX_ZOOM - mapRef.current.leafletElement.getZoom()) ** 1.6;\n\n        const circle = L.circle(circleCenter, radius, options)\n            .on('mouseover', (e) => {\n                // console.log('mouseover stayathome circle: ', obj);\n                createStayAtHomePopup(e, obj)\n            })\n            .on('mousedown', (e) => {\n                setClickedData(obj);\n                setCurrentDestinationData({\n                    from: obj.SA2_name_usual_residence_address,\n                    to: obj.SA2_name_workplace_address\n                })\n            })\n            .on('mouseout', (e) => {\n                mapRef.current.leafletElement.closePopup();\n            })\n            .addTo(mapRef.current.leafletElement);\n        return circle;\n    }\n\n    // Draw cluster circles.\n    const createCircle = (lat, lon, clusterCount, commuteType, amplifyAmt) => {\n        var circleCenter = [lat, lon];\n        // console.log(COMMUTE_METHOD_COLOUR, commuteType, COMMUTE_METHOD_COLOUR[commuteType])\n        var options = {\n            weight: 1.5,\n            color: 'rgba(255,0,0,0)',//'rgba(255,0,0,.35)',\n            fillColor: COMMUTE_METHOD_COLOUR[commuteType],\n            fillOpacity: 0.5,//0.35,\n        }\n\n        // Radius dependent on number of commutes in this circle.\n        var radius = clusterCount / 2000 + 2; //3.25\n        if(amplifyAmt)\n            radius *= amplifyAmt ** 4.2;\n        console.log('amplifyAmt: ', amplifyAmt)\n        // console.log(L.divIcon)\n        // L.divIcon({\n        //     className: '',\n        //     html: `\n        //         <div>\n        //             <p>${clusterCount}</p>\n        //         </div>\n        //     `\n        // }).addTo(mapRef.current.leafletElement);\n        \n        const circle = L.circle(circleCenter, radius, options)\n            .addTo(mapRef.current.leafletElement);\n        circles.push(circle);\n    }  \n    /*\n    const createCurrentLatLngCircle = () => {\n        if(currentPositionCircle !== null)\n            currentPositionCircle.remove();\n\n        var circleCenter = [currentLatLng.lat, currentLatLng.lng];\n        var options = {\n            weight: 1.5,\n            color: 'rgba(0,0,255,.5)',\n            fillColor: '#f03',\n            fillOpacity: 0.35,\n        }\n\n        // Radius dependent on number of commutes in this circle.\n        var radius = 2500;\n\n        var circle = L.circle(circleCenter, radius, options)\n            .addTo(mapRef.current.leafletElement);\n        return circle;\n    }\n    */\n\n    const createCurve = (lon1, lat1, lon2, lat2, obj, b_currentSelectedCurve) => {\n        // Draw a circle if it is stay at home\n        // console.log(obj.COMMUTE_TYPE);\n        if(['STUDY_AT_HOME','WORK_AT_HOME'].includes(obj.COMMUTE_TYPE)){\n            return createStayAtHomeCircle(lat1, lon1, obj);\n        }\n\n        const points = [];\n        var delta_x = lon2 - lon1,\n            delta_y = lat2 - lat1;\n        \n        var r = Math.sqrt(Math.pow(delta_x, 2) + Math.pow(delta_y, 2)),\n        theta = Math.atan2(delta_y, delta_x);\n\n        var thetaOffset = (3.14 / 10);\n\n        var r2 = (r / 2) / (Math.cos(thetaOffset)),\n        theta2 = theta + thetaOffset;\n\n        var midpointX = (r2 * Math.cos(theta2)) + lon1,\n            midpointY = (r2 * Math.sin(theta2)) + lat1;\n\n        var midpointLatLng = [midpointY, midpointX];\n\n        points.push([lon1, lat1], midpointLatLng, [lon2, lat2]);\n\n        var pathOptions = {\n            // color: dataType === \"WORK\" \n            //     ? COMMUTE_PURPOSE_COLOUR.WORK \n            //     : COMMUTE_PURPOSE_COLOUR.EDUCATION,\n            color: COMMUTE_METHOD_COLOUR[DB_2_COMMUTE_METHOD[obj.COMMUTE_TYPE]],\n            weight: b_currentSelectedCurve\n                ? HIGHLIGHTED_STROKE_WEIGHT + (Number(obj.COUNT) * STROKE_COUNT_MULTIPLIER + 1.5)\n                : INITIAL_STROKE_WEIGHT + (Number(obj.COUNT) * STROKE_COUNT_MULTIPLIER),\n            opacity: b_currentSelectedCurve\n                ? HIGHLIGHTED_OPACITY\n                : INITIAL_OPACITY + (Number(obj.COUNT) * OPACITY_MULTIPLIER),\n        }\n\n        // const map = L.map('sampleMap')\n\n        const curve = L.curve([\n            'M',\n            //[lon1, lat1],\n            [lat1, lon1],\n            'Q',\n            midpointLatLng,\n            [lat2, lon2]//[lon2, lat2]\n        ], pathOptions)\n        .on('mouseover', function(e) {\n            // console.log('mouseover: ', obj)\n\n            if(!b_currentSelectedCurve){\n                this.setStyle({\n                    weight: HIGHLIGHTED_STROKE_WEIGHT + (Number(obj.COUNT) * STROKE_COUNT_MULTIPLIER),\n                    opacity: HIGHLIGHTED_OPACITY,\n                })\n                setHoveredData({\n                    hoveredData: obj,\n                    hoveredDestination: obj.destination_SA22018_V1_NAME//f.properties.NAME_1\n                });\n                setHighlightedData(obj)\n                // console.log(obj)\n                createPopup(e, obj);\n            }\n\n        })\n        .on('mouseout', function() {\n            if(!b_currentSelectedCurve){\n                this.setStyle({\n                    weight: INITIAL_STROKE_WEIGHT + (Number(obj.COUNT) * STROKE_COUNT_MULTIPLIER),\n                    opacity: INITIAL_OPACITY + (Number(obj.COUNT) * OPACITY_MULTIPLIER),\n                })\n                mapRef.current.leafletElement.closePopup();\n            }\n        })\n        .on('mousedown', function(){\n            // console.log('path clicked, ', obj)\n            setClickedData(obj);\n            setCurrentDestinationData({\n                from: obj.SA2_name_usual_residence_address,\n                to: obj.SA2_name_workplace_address\n            })\n            updateCurrentSelectedCurve(obj);\n        })\n        //.addTo(mapRef.current.leafletElement)\n        .addTo(mapRef.current.leafletElement)\n        // console.log(curve._path);\n        // curve._path.id = obj.id;\n        curve._path.classList.add(obj.id);\n        curve._path.classList.add('pathFadeIn');\n        // curves.push(curve);\n        // console.log(mapRef.current.leafletElement)\n        return curve;  \n    }\n\n    const createPopup = (e, obj) => {\n        L.popup({\n            closeButton: false,\n            autoPan: false,\n        })\n            .setLatLng(e.latlng)\n            .setContent(\n                '<p><b>' + obj.DEPARTURE_NAME_1 + ', ' + obj.SA2_name_usual_residence_address\n                + ' → '//' > ' //<img src={arrow_right} alt=\"\" /> \n                + obj.DESTINATION_NAME_1 + ', ' + (obj.SA2_name_workplace_address || obj.SA2_name_educational_address) + '</p>'\n\n                + '<p>' + Number(obj.HAVERSINE_DISTANCE).toFixed(2) + 'km <span class=\"' + obj.COMMUTE_TYPE + '\">' + key2CommuteType(obj.COMMUTE_TYPE) + '</span></p></b>'\n                + '<hr/>'\n                // + '<div style=\"display:flex;justify-content:space-between;\"><div><b>' + obj.COUNT + '</b> people ' + '</div><div><span class=\"' + obj.COMMUTE_TYPE + '\">' + key2CommuteType(obj.COMMUTE_TYPE) + '</span></div></div>'\n                + '<div><b>' + obj.COUNT + '</b> people ' + '</div>'\n                + '<p>Commuting for <b>' + obj.TYPE.toLowerCase() + '</b></p>' //obj.TYPE.charAt(0) + obj.TYPE.substring(1).toLowerCase() + \n            )\n            // .addTo(mapRef.current.leafletElement);\n            .openOn(mapRef.current.leafletElement);\n    }\n\n    const createStayAtHomePopup = (e, obj) => {\n        L.popup({\n            closeButton: false,\n            autoPan: false,\n        })\n            .setLatLng(e.latlng)\n            .setContent(\n                '<p><b>' + obj.DEPARTURE_NAME_1 + ', ' + obj.SA2_name_usual_residence_address\n                + '<p><span class=\"' + obj.COMMUTE_TYPE + '\">' + key2CommuteType(obj.COMMUTE_TYPE) + '</span></p></b>'\n                + '<hr/>'\n                + '<div><b>' + obj.COUNT + '</b> people ' + '</div>'\n                + '<p>Commuting for <b>' + obj.TYPE.toLowerCase() + '</b></p>' //obj.TYPE.charAt(0) + obj.TYPE.substring(1).toLowerCase() + \n            )\n            // .addTo(mapRef.current.leafletElement);\n            .openOn(mapRef.current.leafletElement);\n    }\n    \n\n    /*\n    const pathOne = [\n        'M', [50.14874640066278, 14.106445312500002],\n        'Q', [51.67255514839676, 16.303710937500004],\n        [50.14874640066278, 18.676757812500004],\n        'T', [49.866316729538674, 25.0927734375]\n    ]\n    */\n\n    return(\n        <Map\n            ref={mapRef}\n            center={position} \n            zoom={MIN_ZOOM}  //13\n            zoomControl={true}\n            maxBounds={L.latLngBounds(topLeft, bottomRight)}\n            minZoom={5}\n            maxZoom={MAX_ZOOM}\n            layers={[]}\n\n            // setPath={createCurve(170.138842, -31.154944, 179.794907, -49.285522)}\n        >\n            {/* {console.log(\"mapRef.current \", mapRef.current)} */}\n            <TileLayer\n                // This defines what kind of tiles we want, and the type of the map\n                // url=\"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png\"\n\n                // jun.a.kagaya@gmail.com\n                // url=\"https://api.maptiler.com/maps/basic/{z}/{x}/{y}.png?key=9Ada5vIEJbJjNQrKmV7i\"\n                // a.jun.kagaya@gmail.com\n                url=\"https://api.maptiler.com/maps/basic/{z}/{x}/{y}.png?key=tYXqZFaglZBPM8w9KlP7\"\n                //attribution=\"&copy; <a href=&quot;http://osm.org/copyright&quot;>OpenStreetMap</a> contributors\"\n                // url=\"http://tile.stamen.com/terrain/{z}/{x}/{y}.jpg\"\n                // url=\"http://tile.stamen.com/watercolor/{z}/{x}/{y}.jpg\"\n                // url=\"http://b.tile.openstreetmap.fr/hot/${z}/${x}/${y}.png\"\n                // WHEN USING HTTPS\n                // url=\"https://stamen-tiles.a.ssl.fastly.net/watercolor/{z}/{x}/{y}.jpg\"\n                // url=\"http://tile.stamen.com/toner/{z}/{x}/{y}.png\"\n                // attribution='Map tiles by <a href=\"http://stamen.com\" style=\"pointer-events: initial;\">Stamen Design</a>, under <a href=\"http://creativecommons.org/licenses/by/3.0\" style=\"pointer-events: initial;\">CC BY 3.0</a>. Data by <a href=\"http://openstreetmap.org\" style=\"pointer-events: initial;\">OpenStreetMap</a>, under <a href=\"http://www.openstreetmap.org/copyright\" style=\"pointer-events: initial;\">ODbL</a>.'\n                attribution='<a href=\"https://www.maptiler.com/copyright/\" target=\"_blank\">&copy; MapTiler</a> <a href=\"https://www.openstreetmap.org/copyright\" target=\"_blank\">&copy; OpenStreetMap contributors</a>'\n            />\n            \n        </Map>\n    );\n}\n//)\n\nexport default LeafletMap;\n\n\n{/* <Marker position={position}>\n                    <Popup>A pretty CSS3 popup.<br />Easily customizable.</Popup>\n                </Marker> */}\n\n                {/* <Curve positions={pathOne} option={{color:'red',fill:true}}/> */}\n\n\n// setDataType(\"TOTAL\");\n// console.log(mapRef.current.leafletElement)\n// if(!m){\n//     // console.log(\"assigning map: \", mapRef.current.leafletElement)\n//     setMap(mapRef.current.leafletElement);\n// }\n\n        \n\n/*\nvar legend = L.control()//({ position: \"topright\" });\nlegend.onAdd = function(map){\n    var div = L.DomUtil.create('div', 'info legend');\n\n    for (var commutePurpose of Object.keys(COMMUTE_PURPOSE_COLOUR)){\n        div.innerHTML += \n            '<i style=\"background:' + COMMUTE_PURPOSE_COLOUR[commutePurpose] + '\"></i> ' + \n            '<span>' + commutePurpose + '</span>';\n    }\n    return div;\n}\nlegend.addTo(mapRef.current.leafletElement);\n*/\n\n/*\nvar bounds = mapRef.current.leafletElement.getBounds();\nconsole.log(bounds)\n// Load initial data\nconst zoom = mapRef.current.leafletElement.getZoom();\n// const dataType = currentMap.option.toUpperCase();\n// If total, request both data types\nif(commutePurpose === \"TOTAL\"){\n    API_zoneData(bounds, zoom, \"EDUCATION\");\n    API_zoneData(bounds, zoom, \"WORK\");\n} else {\n    // Otherwise just search directly\n    API_zoneData(bounds, zoom, commutePurpose);\n}\n*/\n\n/*\n{\n    {\n    _northEast: {\n        lat: lastRequestedLatLng.top, \n        lng: lastRequestedLatLng.right\n    },\n    _southWest: {\n        lat: lastRequestedLatLng.bottom, \n        lng: lastRequestedLatLng.left\n    }\n}\n*/\n// mapRef.current.leafletElement.commuteType = \"TOTAL\";\n\n// If incoming data is work, and row is education, then ignore it.\n        // if(commutePurpose === \"TOTAL\"){\n        //     Object.keys(toDelete).forEach((id)=>{\n        //         if(id.substring(0,1) !== dataType.substring(0,1)){\n        //             toDelete[id] = undefined;\n        //             delete toDelete[id];\n        //         }\n        //     })\n        // } \n        // else if(dataType === \"EDUCATION\" && commutePurpose === \"TOTAL\"){\n        //     Object.keys(toDelete).forEach((id)=>{\n        //         console.log(id)\n        //         if(id.substring(0,1) === 'W'){\n        //             toDelete[id] = undefined;\n        //             delete toDelete[id];\n        //         }\n        //     })\n        // }","import React, { useEffect, useState, useMemo, useRef } from \"react\";\nimport useSWR from \"swr\";\nimport { json } from \"d3-fetch\";\nimport { scaleOrdinal, scaleSqrt, scaleSequential } from \"d3-scale\";\nimport {\n  interpolateReds,\n  interpolateBlues,\n  interpolateGreens,\n  interpolateGreys,\n  interpolatePurples,\n} from \"d3-scale-chromatic\";\nimport { max } from \"d3-array\";\nimport { select, event, selectAll } from \"d3-selection\";\nimport { geoMercator, geoPath, geoContains } from \"d3-geo\";\nimport { transition } from \"d3-transition\";\nimport { useTranslation } from \"react-i18next\";\nimport * as topojson from \"topojson\";\nimport * as Icon from \"react-feather\";\nimport {\n  DATA_URL_ROOT,\n  MAP_META,\n  D3_TRANSITION_DURATION,\n  MAP_TYPES,\n  MAP_STROKE_WIDTH,\n  MAP_STROKE_WIDTH_HIGHLIGHTED,\n  MAP_CIRCLE_RADIUS,\n  REGION_STROKE_WIDTH,\n  MAP_OPTIONS,\n  ZONE_COLORS,\n  DISTRICT_POPULATIONS_MIL,\n  CITY_CODES,\n  CITY_NAMES,\n  COLORS,\n  UNKNOWN_DISTRICT_KEY,\n} from \"../constants\";\nimport {\n  capitalizeAll,\n  formatNumber,\n  getStatistic,\n} from \"../utils/commonFunctions\";\nimport { CodeSquareIcon } from \"@primer/octicons-v2-react\";\nimport LeafletMap from './leafletMap';\n\nconst [width, height] = [432, 488];\n\n//TODO create a separate value for this (district value)\nconst getTotalStatistic = (data, statistic, normalizer = 1) => {\n  return \"0\";//getStatistic(data, \"total\", statistic, normalizer);\n};\n\nconst colorInterpolator = {\n  confirmed: (t) => interpolateReds(t * 0.85),\n  active: (t) => interpolateBlues(t * 0.85),\n  recovered: (t) => interpolateGreens(t * 0.85),\n  deceased: (t) => interpolateGreys(t * 0.85),\n  tested: (t) => interpolatePurples(t * 0.85),\n};\n\nfunction MapVisualizer({\n  currentMap,\n  data,\n  regionalEducationData,\n  regionalWorkData,\n  regionalTotalData,\n  centroidData,\n  setRegionalData,\n  currentView,\n  setCurrentView,\n  changeMap,\n  regionHighlighted,\n  setRegionHighlighted,\n  setHoveredData,\n  setHighlightedData,\n  statistic,\n  isCountryLoaded,\n  currentCommuteTypes,\n  setCurrentDestinationData,\n  setClickedData,\n  mapRef,\n}) {\n  const { t } = useTranslation();\n  const svgRef = useRef(null);\n\n  const mapMeta = MAP_META['NZ'];\n\n  // Load topoJSON file\n  const { data: geoData } = useSWR(\n    mapMeta.geoDataFile,\n    async (file) => {\n      return await json(file);\n    },\n    { revalidateOnFocus: false, suspense: true }\n  );\n\n  // console.log(\"currentMap.option: \", currentMap.option);\n\n  // console.log(data);\n\n  //TODO this needs to be dependent on the tab that is currently showing.\n  const statisticMax = useMemo(() => {\n    const districtCodes = Object.keys(data).filter(\n      (districtCode) =>\n        districtCode !== \"NZ\" && Object.keys(MAP_META).includes(districtCode)\n    );\n    return currentMap.view === MAP_TYPES.COUNTRY\n      ? max(districtCodes, (districtCode) =>\n          getTotalStatistic(\n            data[districtCode],\n            statistic,\n            //TODO get the number of entries and total of all combined for this district.\n            // This can be hardcoded as an API endpoint.\n            currentMap.option === MAP_OPTIONS.PER_MILLION\n              ? DISTRICT_POPULATIONS_MIL[districtCode]\n              : 1\n          )\n        )\n      : max(districtCodes, (districtCode) =>\n          data[districtCode]?.districts\n            ? max(Object.values(data[districtCode].districts), (districtData) =>\n                getTotalStatistic(districtData, statistic)\n              )\n            : 0\n        );\n  }, [data, currentMap.option, currentMap.view, statistic]);\n\n  const statisticTotal = useMemo(() => {\n    return getTotalStatistic(\n      data[currentMap.code],\n      statistic,\n      currentMap.option === MAP_OPTIONS.PER_MILLION\n        ? DISTRICT_POPULATIONS_MIL[currentMap.code]\n        : 1\n    );\n  }, [data, currentMap.code, currentMap.option, statistic]);\n\n  const mapScale = useMemo(() => {\n    // console.log(currentMap.option);\n    if (currentMap.option === MAP_OPTIONS.ZONES) {\n      return scaleOrdinal(Object.keys(ZONE_COLORS), Object.values(ZONE_COLORS));\n    } else if (currentMap.option === MAP_OPTIONS.HOTSPOTS) {\n      return scaleSqrt([0, Math.max(statisticMax, 1)], [0, 40])\n        .clamp(true)\n        .nice(3);\n    } else {\n      return scaleSequential(\n        [0, Math.max(1, statisticMax)],\n        colorInterpolator[statistic]\n      ).clamp(true);\n    }\n  }, [currentMap.option, statistic, statisticMax]);\n\n  useEffect(()=>{\n    // setupDataframe(); // Only use this to create the initial dataframe\n  }, []);\n\n  useEffect(() => {\n    const topology = topojson.feature(\n      geoData,\n      geoData.objects[mapMeta.graphObjectStates || mapMeta.graphObjectDistricts]\n    );\n\n    const svg = select(svgRef.current);\n\n    const projection = geoMercator().fitSize([width, height], topology);\n    const path = geoPath(projection);\n\n    let features =\n      currentMap.view === MAP_TYPES.DISTRICT\n        ? topojson.feature(geoData, geoData.objects[mapMeta.graphObjectStates])\n            .features\n        : mapMeta.mapType === MAP_TYPES.COUNTRY &&\n          currentMap.option === MAP_OPTIONS.HOTSPOTS\n        ? [\n            ...topojson.feature(\n              geoData,\n              geoData.objects[mapMeta.graphObjectStates]\n            ).features,\n            ...topojson.feature(\n              geoData,\n              geoData.objects[mapMeta.graphObjectDistricts]\n            ).features,\n          ]\n        : topojson.feature(\n            geoData,\n            geoData.objects[mapMeta.graphObjectDistricts]\n          ).features;\n\n    // Add id to each feature\n    // var str = \"\"; // This is used to create the CITY_NAMES dictionary under ../constants\n    features = features.map((f) => {\n      // str += `${f.properties.NAME_2}: \"${f.properties.NAME_2}\",\\n`\n      const obj = Object.assign({}, f);\n      obj.id = `${currentMap.code}-${f.properties.HASC_2}`; //`${currentMap.code}-${state}${district ? \"-\" + district : \"\"}`;\n      return obj;\n    });\n\n    // console.log(str)\n\n    const fillColor = (d) => {\n      const districtCode = CITY_CODES[d.properties.NAME_1];\n      const city = d.properties.NAME_2;\n      const districtData = data[districtCode];\n      const cityData = districtData?.districts?.[city];\n      let n;\n      if (currentMap.option === MAP_OPTIONS.HOTSPOTS) {\n        n = cityData?.zone || 0;\n      } else {\n        if (city) n = getTotalStatistic(cityData, statistic);\n        else\n          n = getTotalStatistic(\n            districtData,\n            statistic,\n            currentMap.option === MAP_OPTIONS.PER_MILLION\n              ? DISTRICT_POPULATIONS_MIL[districtCode]\n              : 1\n          );\n      }\n      const color = n === 0 ? \"#ffffff00\" : mapScale(n);\n\n      return color;\n    };\n\n    const strokeColor = (d) => {\n      return '#000000'; //'#c3c9c8' //'#d2d6d5'; //'#6c757d91'; //'#000000'; //TODO remove this;\n      return currentMap.option === MAP_OPTIONS.ZONES\n        ? \"#343a40\"\n        : COLORS[statistic];\n    };\n\n    const initialFillColor = (d) => {\n      return \"#ffffff00\"; //'#c3c9c8';\n    };\n\n    // takes in d.properties.NAME_2\n    const getRegionalData = (districtName) => {\n      // console.log(currentMap.option, regionalTotalData)\n      switch(currentMap.option){\n        case(MAP_OPTIONS.TOTAL): return (regionalTotalData || {})[districtName];\n        case(MAP_OPTIONS.WORK): return (regionalWorkData || {})[districtName];\n        case(MAP_OPTIONS.EDUCATION): return (regionalEducationData || {})[districtName];\n        default: return (regionalTotalData || {})[districtName];\n      }\n    }\n\n    const districtClicked = (d) => {\n      var x, y, k;\n      var centered = null;\n      \n      // console.log('district clicked: ', width, height, path.centroid(d));\n\n      if(d && centered !== d){\n        var centroid = path.centroid(d);\n        x = centroid[0];\n        y = centroid[1];\n        k = 9; //4 //12\n        centered = d;\n      } else {\n        x = width / 2;\n        y = height / 2;\n        k = 1;\n        centered = null;\n      }\n      // console.log('x: ', x, \"y: \", y, centroid);\n  \n      svg.selectAll('path')\n        .classed(\"active\", centered && function(d) { return d === centered; });\n      \n      svg.transition()\n        .duration(D3_TRANSITION_DURATION)\n        .attr(\"transform\", \"translate(\" + width * (k/2) + \",\" + height * (k/2.15) + \")scale(\" + k + \")translate(\" + -x + \",\" + -y + \")\")\n        // .style(\"stroke-width\", 1.5 / k + \"px\");\n        // .style(\"stroke-width\", 0.125 + \"rem\");\n    }\n\n    /* Draw map */\n    const t = transition().duration(D3_TRANSITION_DURATION);\n    let onceTouchedRegion = null;\n    const regionSelection = svg\n      .select(\".regions\")\n      .selectAll(\"path\")\n      .data(\n        currentMap.option !== MAP_OPTIONS.HOTSPOTS ? features : [],\n        (d) => d.id\n      )\n      .join(\n        (enter) => {\n          const sel = enter\n            .append(\"path\")\n            .attr(\"d\", path)\n            .attr(\"stroke-width\", REGION_STROKE_WIDTH) //1.8 //1\n            .attr(\"stroke-opacity\", 0) //0 //1\n            // .attr('fill', \"#ff0000\")\n            // .attr('fill-opacity', 1)\n            .style(\"cursor\", \"pointer\")\n            .on(\"mouseenter\", (d) => {\n              // console.log(currentMap.option, currentMap.option === MAP_OPTIONS.TOTAL)\n              setRegionHighlighted({\n                districtCode: CITY_CODES[d.properties.NAME_2], // Unique on city names\n                cityName: d.properties.NAME_2,\n              });\n              setRegionalData(getRegionalData(d.properties.NAME_2))\n            })\n            .on(\"mouseleave\", (d) => {\n              if (onceTouchedRegion === d) onceTouchedRegion = null;\n            })\n            .on(\"touchstart\", (d) => {\n              if (onceTouchedRegion === d) onceTouchedRegion = null;\n              else onceTouchedRegion = d;\n            })\n            .attr(\"fill\", initialFillColor)\n            // .attr('fill', fillColor)\n            .attr(\"stroke\", strokeColor);\n          sel.append(\"title\");\n          return sel;\n        },\n        (update) =>\n          update.call((update) =>\n            // console.log('updating!!: '),\n            update\n              .transition(t)\n              .attr(\"fill\", fillColor)\n              .attr(\"stroke\", strokeColor)\n          )\n      )\n      .attr(\"pointer-events\", \"all\")\n      .on(\"click\", (d) => {\n        // Setting state here causes interpolation to pause.\n        setCurrentView({\n          view: MAP_TYPES.DISTRICT\n        });\n\n        event.stopPropagation();\n        const districtCode = CITY_CODES[d.properties.NAME_2];\n        // Zoom in on the map\n        districtClicked(d);\n        if (\n          onceTouchedRegion ||\n          mapMeta.mapType === MAP_TYPES.COUNTRY ||\n          !data[districtCode]?.NAME_2\n        )\n          return;\n        // Disable pointer events till the new map is rendered\n        svg.attr(\"pointer-events\", \"none\");\n        svg.select(\".regions\").selectAll(\"path\").attr(\"pointer-events\", \"none\");\n        // Switch map\n        // changeMap(CITY_CODES[d.properties.NAME_1]);\n\n      });\n\n    regionSelection.select(\"title\").text((d) => {\n      if (currentMap.option === MAP_OPTIONS.TOTAL) {\n        const district = d.properties.NAME_1;\n        const districtCode = CITY_CODES[district];\n        const city = d.properties.NAME_2;\n        const districtData = data[districtCode];\n        const cityData = districtData?.city?.[city];\n        let n;\n        if (city) n = getTotalStatistic(cityData, statistic);\n        else n = getTotalStatistic(districtData, statistic);\n        return (\n          // formatNumber(100 * (n / (statisticTotal || 0.001))) +\n          // \"% from \" +\n          capitalizeAll(city ? city : district)\n        );\n      }\n    });\n\n    svg\n      .transition()\n      .duration(mapMeta.mapType === MAP_TYPES.DISTRICT ? t.duration() / 2 : 0)\n      .on(\"end\", () =>\n        svg.attr(\n          \"class\",\n          currentMap.option === MAP_OPTIONS.HOTSPOTS ? \"zone\" : \"\"\n        )\n      );\n\n    /* ------- START OF Commute Lines -------- */\n\n    // CLear existing data\n    svg.selectAll('path.route').remove();\n    svg.selectAll(\"circle.pin\").remove();\n\n    //For each key\n    Object.keys(data).forEach((key) => {\n      // console.log(key);\n      const color = \n        key === \"workMapData\" \n        ? ZONE_COLORS.Red\n        : COLORS.active;\n\n      svg.selectAll('.routes')\n        .data(data[key]) // [] // to debug // data\n        .enter()\n        .append('path')\n          .attr('class', 'route')\n          .attr('cursor', 'pointer')\n          .attr('fill-opacity', 0.5)\n          .attr(\"stroke\", color) //TODO get stroke Color, which sets based on work or education\n          .attr(\"stroke-width\", MAP_STROKE_WIDTH) //.15\n          .attr(\"fill\", color)\n          .attr('d', function (d) {\n            var coordDepart = [d.departure_LONGITUDE, d.departure_LATITUDE];\n            var coordArrivee = [d.destination_LONGITUDE, d.destination_LATITUDE];\n            return path({\n              type: 'LineString',\n              coordinates: [\n                coordDepart,\n                coordArrivee\n              ]\n            });\n          })\n          // .attr(\"pointer-events\", \"all\")\n          // .on(\"click\", (d) => {\n          .on(\"mouseenter\", (d) => {\n            // console.log('path hovered: ', d);\n            \n            const features = topojson.feature(\n              geoData,\n              geoData.objects[mapMeta.graphObjectDistricts]\n            ).features;\n            // features.some() <= this function is good, but only returns boolean.\n            for(var f of features){\n              if(geoContains(\n                f, \n                [d.destination_LONGITUDE, d.destination_LATITUDE]\n              )){\n                // console.log(f)\n                setHoveredData({\n                  hoveredData: d,\n                  hoveredDestination: f.properties.NAME_1\n                });\n                break;\n              }\n            }\n            //TODO highlighted change stroke width\n            // console.log(\"Make this highlighting work!!! \", d);\n            // const highlighted = true; //d.id === select(this).id;\n            // if (highlighted) this.parentNode.appendChild(this);\n            // select(this).style('stroke-width', highlighted ? MAP_STROKE_WIDTH_HIGHLIGHTED : REGION_STROKE_WIDTH);\n          });\n    });\n\n      // Add circles to each end\n    Object.keys(data).forEach((key) => { \n      const color = \n        key === \"workMapData\" \n        ? ZONE_COLORS.Red\n        : COLORS.active;\n\n      svg\n        .selectAll(\".pin\")\n        .data(data[key])\n        .enter()\n        .append(\"circle\", \".pin\")\n          .on(\"mouseenter\", (d) => {\n            console.log('circle hovered: ', d);\n            setHoveredData({\n              hoveredData: d,\n              hoveredDestination: \"\",\n            })\n          })\n          .attr('class', 'pin')\n          .attr('cursor', 'pointer')\n          .attr(\"r\", MAP_CIRCLE_RADIUS) //.35 //.15\n          .attr(\"fill\", color)\n          .attr(\"transform\", function (d) {\n            return (\n              \"translate(\" +\n              projection([d.departure_LONGITUDE, d.departure_LATITUDE]) +\n              \")\"\n            );\n          })\n      \n    })\n\n\n    /* ------ END OF Commute Lines ------- */\n\n    let meshCountry = [];\n    if (mapMeta.mapType === MAP_TYPES.COUNTRY) {\n      meshCountry = [\n        topojson.mesh(geoData, geoData.objects[mapMeta.graphObjectStates]),\n      ];\n      meshCountry[0].id = mapMeta.graphObjectStates;\n    }\n    let meshDistricts = [];\n    if (currentMap.view === MAP_TYPES.DISTRICT) {\n      // Add id to mesh\n      meshDistricts = [\n        topojson.mesh(geoData, geoData.objects[mapMeta.graphObjectDistricts]),\n      ];\n      meshDistricts[0].id = mapMeta.graphObjectDistricts;\n    }\n\n    svg\n      .select(\n        // currentMap.view === MAP_TYPES.COUNTRY\n        //   ? '.state-borders'\n        //   : '.district-borders'\n        \".state-borders\"\n        // '.district-borders'\n      )\n      .attr(\"fill\", 'none') //\"none\"\n      .attr(\"stroke-width\", function () {\n        return (\n          // mapMeta.mapType === MAP_TYPES.COUNTRY\n          // console.log(currentView.view),\n          // currentView.view === MAP_TYPES.COUNTRY\n          // currentMap.view === MAP_TYPES.DISTRICT\n          // ? 0\n          // : 1.5;\n          // Make this thinner when zoomed in.\n          // ? 1\n          // : .1\n          currentView.view === MAP_TYPES.COUNTRY\n          ? .25 \n          : .15\n        );\n      })\n      .selectAll(\"path\")\n      .data(\n        //currentMap.view === MAP_TYPES.COUNTRY ? meshStates : meshDistricts,\n        meshCountry,\n        // meshDistricts,\n        (d) => d.id\n      )\n      .join((enter) => enter.append(\"path\").attr(\"d\", path))\n      .transition(t)\n      .attr(\"stroke\", () => {\n        if (currentMap.option === MAP_OPTIONS.ZONES) {\n          return \"#00000060\";\n        } else {\n          return COLORS[statistic] + \"30\";\n        }\n      });\n\n    // console.log(currentMap.view === MAP_TYPES.COUNTRY);\n    svg\n      .select(\n        //currentMap.view === MAP_TYPES.COUNTRY\n        //  ? '.district-borders'\n        //  : '.state-borders'\n        \".state-borders\"\n        // '.district-borders'\n      )\n      .selectAll(\"path\")\n      .data(\n        //currentMap.view === MAP_TYPES.COUNTRY ? meshDistricts : meshStates,\n        meshCountry,\n        // meshDistricts,\n        (d) => d.id\n      )\n      .join((enter) =>\n        enter\n          .append(\"path\")\n          .attr(\"d\", path)\n          .attr(\"fill\", \"none\") //\"none\"\n          .attr(\"stroke-width\", .05/* .15 // 1.5*/)\n      )\n      .transition(t)\n      .attr(\"stroke\", \"#343a4050\");\n\n    // Reset on tapping outside map\n    svg.attr(\"pointer-events\", \"auto\").on(\"click\", () => {\n      if (mapMeta.mapType !== MAP_TYPES.COUNTRY) {\n        setRegionHighlighted({\n          districtCode: \"NZ\",\n          cityName: null,\n        });\n      }\n    });\n\n    // console.log(\"regionHighlighted.cityName: \", regionHighlighted.cityName);\n    // const regionalData = getRegionalData(regionHighlighted.cityName)\n\n  }, [\n    geoData,\n    data,\n    // regionalData,\n    mapMeta,\n    currentMap,\n    setRegionHighlighted,\n    changeMap,\n    isCountryLoaded,\n    mapScale,\n    statistic,\n    statisticTotal,\n  ]);\n\n  useEffect(() => {\n    // console.log(regionHighlighted);\n    const district = CITY_NAMES[regionHighlighted.districtCode];\n    const city = regionHighlighted.cityName;\n    \n    const svg = select(svgRef.current);\n    // if (currentMap.option === MAP_OPTIONS.HOTSPOTS) {\n    //   svg\n    //     .select('.circles')\n    //     .selectAll('circle')\n    //     .attr('fill-opacity', (d) => {\n    //       const highlighted =\n    //         state === d.properties.st_nm &&\n    //         (!district ||\n    //           district === d.properties?.district ||\n    //           (district === UNKNOWN_DISTRICT_KEY && !d.properties.district));\n    //       return highlighted ? 1 : 0.5;\n    //     });\n    // } else {\n      svg\n        .select('.regions')\n        .selectAll('path')\n        .each(function (d) {\n          // console.log('highlighting: ', d);\n          /*\n          const highlighted =\n            district === d.properties.NAME_1 &&\n            (currentMap.view === MAP_TYPES.COUNTRY ||\n              city === d.properties?.NAME_2);\n          */\n          const highlighted =\n            city === d.properties.NAME_2;\n          /*\n          console.log(\n            'highlighted: ', highlighted, \n            // \"currentMap.view: \", currentMap.view,\n            // \"currentMap.view === MAP_TYPES.COUNTRY: \", \n            // currentMap.view === MAP_TYPES.COUNTRY,\n            \"district: \", district,\n            \"d.properties.NAME_1: \", d.properties.NAME_1,\n            \"city: \", city,\n            \"d.properties?.NAME_2: \", d.properties?.NAME_2\n          );\n          */\n          if (highlighted) this.parentNode.appendChild(this);\n          select(this).attr('stroke-opacity', highlighted ? 1 : 0);\n          select(this).attr('fill-opacity', highlighted ? .95 : 0);\n          select(this).attr('fill', highlighted ? '#000000' : 0);\n        });\n    // }\n  }, [\n    geoData,\n    data,\n    currentMap.option,\n    currentMap.view,\n    regionHighlighted.districtCode,\n    regionHighlighted.cityName,\n    statistic,\n  ]);\n\n  // Add NAME_1, NAME_2 to each departure and destination\n  const setupDataframe = () => {\n    // TODO remove this after running once\n    // POST request to /setup to create the dataframe\n    // 1. Create the data first\n    const work_departures= [];\n    const work_destinations= [];\n    const education_departures= [];\n    const education_destinations= [];\n    // NAME_1 for region location\n    const work_departures_DISTRICT = [];\n    const work_destinations_DISTRICT = [];\n    const education_departures_DISTRICT = [];\n    const education_destinations_DISTRICT = [];\n\n    const features = topojson.feature(\n      geoData,\n      geoData.objects[mapMeta.graphObjectDistricts]\n    ).features;\n\n    var b = false;\n\n    // console.log(data.educationMapData.length);\n    // console.log(data.workMapData.length);\n    for(var r of data.educationMapData){\n      b = false;\n      for(var f of features){\n        if(geoContains(f, [r.departure_LONGITUDE, r.departure_LATITUDE])){\n          education_departures.push(f.properties.NAME_2)\n          education_departures_DISTRICT.push(f.properties.NAME_1)\n          console.log(\"found feature education_departures\");\n          b = true;\n          break;\n        }\n      }\n      if(!b) {\n        education_departures.push(\"\");\n        education_departures_DISTRICT.push(\"\");\n      }\n    }\n\n    for(var r of data.educationMapData){\n      b = false;\n      for(var f of features){\n        if(geoContains(f, [r.destination_LONGITUDE, r.destination_LATITUDE])){\n          education_destinations.push(f.properties.NAME_2) //NAME_1\n          education_destinations_DISTRICT.push(f.properties.NAME_1)\n          console.log('found feature education_destinations')\n          b = true;\n          break;\n        }\n      }\n      if(!b) {\n        education_destinations.push(\"\");\n        education_destinations_DISTRICT.push(\"\");\n      }\n    }\n\n    for(var r of data.workMapData){\n      b = false;\n      for(var f of features){\n        if(geoContains(f, [r.departure_LONGITUDE, r.departure_LATITUDE])){\n          work_departures.push(f.properties.NAME_2) //NAME_1\n          work_departures_DISTRICT.push(f.properties.NAME_1)\n          console.log('found feature work_departures')\n          b = true;\n          break;\n        }\n      }\n      if(!b) {\n        work_departures.push(\"\");\n        work_departures_DISTRICT.push(\"\");\n      }\n    }\n\n    for(var r of data.workMapData){\n      b = false;\n      for(var f of features){\n        if(geoContains(f, [r.destination_LONGITUDE, r.destination_LATITUDE])){\n          work_destinations.push(f.properties.NAME_2) //NAME_1\n          work_destinations_DISTRICT.push(f.properties.NAME_1);\n          console.log(\"found feature work_destinations\")\n          b = true;\n          break;\n        }\n      }\n      if(!b) {\n        work_destinations.push(\"\");\n        work_destinations_DISTRICT.push(\"\");\n      }\n    }\n    // console.log(work_departures.length, work_destinations.length, education_departures.length, education_destinations.length)\n  \n    fetch(DATA_URL_ROOT + \"/setup\", {\n      method: 'POST',\n      mode: 'no-cors',\n      headers: {\n        'Accept': 'application/json',\n        'Content-Type': 'application/json'\n      },\n      // credentials: 'same-origin',\n      body: JSON.stringify({\n        work_departures: work_departures,\n        work_destinations: work_destinations,\n        education_departures: education_departures,\n        education_destinations: education_destinations,\n        work_departures_DISTRICT: work_departures_DISTRICT,\n        work_destinations_DISTRICT: work_destinations_DISTRICT,\n        education_departures_DISTRICT: education_departures_DISTRICT,\n        education_destinations_DISTRICT: education_destinations_DISTRICT,\n      })\n    }).then(()=>{console.log('sent /setup SUCCESS')})\n    .catch((err) =>{console.error(\"Error sending request: \", err)})\n    \n  }\n\n  return (\n    <React.Fragment>\n      <LeafletMap \n        setHoveredData={setHoveredData}\n        setHighlightedData={setHighlightedData}\n        currentMap={currentMap}\n        centroidData={centroidData}\n        currentCommuteTypes={currentCommuteTypes}\n        setCurrentDestinationData={setCurrentDestinationData}\n        setClickedData={setClickedData}\n        mapRef={mapRef}\n        // ref={leafletMapRef} // Can use ref on React.forwardRef components\n      />\n      {/* <div className=\"svg-parent\">\n        <svg\n          id=\"chart\"\n          viewBox={`0 0 ${width} ${height}`}\n          preserveAspectRatio=\"xMidYMid meet\"\n          ref={svgRef}\n        >\n          <g className=\"regions\" />\n          <g className=\"state-borders\" />\n          {currentMap.view === MAP_TYPES.COUNTRY && (\n            <g className=\"district-borders\" />\n          )}\n          {currentMap.option === MAP_OPTIONS.HOTSPOTS && (\n            <g className=\"circles\" />\n          )}\n        </svg>\n    \n        {mapMeta.mapType === MAP_TYPES.DISTRICT &&\n          !!getTotalStatistic(\n            data[currentMap.code]?.districts?.[UNKNOWN_DISTRICT_KEY],\n            statistic\n          ) && (\n            <div className=\"disclaimer\">\n              <Icon.AlertCircle />\n              {t(\"District-wise {{statistic}} numbers need reconciliation\", {\n                statistic: t(statistic),\n              })}\n            </div>\n          )}\n      </div> */}\n\n      {/* {mapScale && (\n            <MapLegend\n                data={data}\n                mapScale={mapScale}\n                mapOption={currentMap.option}\n                statistic={statistic}\n            />\n            )} */}\n\n      {/* <svg style={{ position: \"absolute\", height: 0 }}>\n        <defs>\n          <filter id=\"balance-color\" colorInterpolationFilters=\"sRGB\">\n            <feColorMatrix\n              type=\"matrix\"\n              values=\"0.91372549  0           0            0  0.08627451\n                            0           0.91372549  0            0  0.08627451\n                            0           0           0.854901961  0  0.145098039\n                            0           0           0            1  0\"\n            />\n          </filter>\n        </defs>\n      </svg> */}\n    </React.Fragment>\n  );\n}\n\nexport default MapVisualizer;\n\n// Top of map is probably Three Kings Islands\n    // const top = -34.154944; // Latitude\n    // const topLongitude = 172.138113;\n    // Bottom of map is bottom of Stewart Island\n    // const bottom = -47.285522; // Latitude\n    // const bottomLongitude = 167.490438;\n    // const right = 179.794907;\n    // const left = 164.138842;\n\n    /*\n    const circlesData = [\n      {\n        name: \"Auckland\",\n        location: {\n          latitude: -36.89981,\n          longitude: 174.537433,\n        },\n      },\n      {\n        name: \"Canterbury\",\n        location: {\n          latitude: -43.57914,\n          longitude: 172.355433,\n        },\n      },\n    ];\n    */\n\n    // console.log(data);\n\n    /*\n        const linesData = [\n          {\n            type: \"LineString\",\n            coordinates: [\n              [174.537433, -36.899810],\n              [172.355433, -43.579140]\n            ]\n          }\n        ]\n        */\n    \n    // const linesData = [\n    //   {\n    //     departure: [174.537433 /* Longitude */, -36.89981 /* Latitude */],\n    //     destination: [172.355433, -43.57914],\n    //   },\n    // ];\n    \n    /*\n        var arcs = svg.append(\"g\")\n          .attr(\"class\",\"arcs\");\n\n        // http://bl.ocks.org/mhkeller/f41cceac3e7ed969eaeb\n        const lngLatToArc = (d, bend) => {\n          bend = bend || 1;\n          const from = d['departure'];\n          const to = d['destination'];\n\n          var sourceXY = projection(from),\n\t\t\t\t\ttargetXY = projection(to);\n\n          var sourceX = sourceXY[0],\n              sourceY = sourceXY[1];\n\n          var targetX = targetXY[0],\n              targetY = targetXY[1];\n\n          var dx = targetX - sourceX,\n              dy = targetY - sourceY,\n              dr = Math.sqrt(dx * dx + dy * dy)*bend;\n\n          console.log(dx, dy, dr);\n\n          // To avoid a whirlpool effect, make the bend direction consistent regardless of whether the source is east or west of the target\n          var west_of_source = (targetX - sourceX) < 0;\n          if (west_of_source) return \"M\" + targetX + \",\" + targetY + \"A\" + dr + \",\" + dr + \" 0 0,1 \" + sourceX + \",\" + sourceY;\n          return \"M\" + sourceX + \",\" + sourceY + \"A\" + dr + \",\" + dr + \" 0 0,1 \" + targetX + \",\" + targetY;\n        }\n        \n        svg.selectAll(\"path\")\n          .data(linesData)\n          .enter()\n          .append(\"path\")\n          .attr('d', (d) => lngLatToArc(d, 5));\n*/\n\n    /*\n        svg.selectAll(\"line\")\n          .data(linesData)\n          .enter()\n          .append(\"line\")\n          .attr('fill-opacity', 0.5)\n          .attr(\"stroke\", \"#ff0000\")\n          .attr(\"stroke-width\", 5)\n          .attr(\"fill\", \"#ff0000\")\n          .attr(\"x1\", d=>projection(d.departure)[0])\n          .attr(\"y1\", d=>projection(d.departure)[1])\n          .attr(\"x2\", d=>projection(d.destination)[0])\n          .attr(\"y2\", d=>projection(d.destination)[1])\n*/\n/*\n        svg.selectAll('.route')\n          .data(linesData)\n          .enter()\n          .append('path')\n            .attr('fill-opacity', 0.5)\n            .attr(\"stroke\", \"#007bff\")\n            .attr(\"stroke-width\", 3)\n            .attr(\"fill\", \"#007bff\")\n            .attr('d', function (d) {\n              var coordDepart = d.departure;\n              var coordArrivee = d.destination;\n              return path({\n                type: 'LineString',\n                coordinates: [\n                  coordDepart,\n                  coordArrivee\n                ]\n              });\n            })\n*/\n/*\n    // 1. Get the longitude & latitude\n    // 2. Find the midpoint\n    // 3. Add 20 to x, and reduce y by 20, this creates a slightly off-center point.\n    // 4. Draw a d3.curve on these three points.\n    // var lineGenerator = d3.line().curve(d3.curveCardinal);\n\n    const linesData2 = [\n      {\n        departure: [174.537433, -36.89981],\n        intermediate: [173, -40],\n        destination: [172.355433, -43.57914],\n      },\n    ];\n\n    svg\n      .selectAll(\"curve\")\n      // .attr('d', curve(linesData))\n      .data(linesData2)\n      .enter()\n      .append(\"path\")\n      // .append('curve')\n      .attr(\"fill-opacity\", 0.5)\n      .attr(\"stroke\", \"#007bff\")\n      .attr(\"stroke-width\", 3)\n      .attr(\"fill\", \"#007bff\")\n      .attr(\"x1\", (d) => projection(d.departure)[0])\n      .attr(\"y1\", (d) => projection(d.departure)[1])\n      // .attr(\"x2\", d=>projection(d.intermediate)[0])\n      // .attr(\"y2\", d=>projection(d.intermediate)[1])\n      .attr(\"x2\", (d) => projection(d.destination)[0])\n      .attr(\"y2\", (d) => projection(d.destination)[1]);\n*/\n\n    // Plot an example point\n    /*\n    svg\n      .selectAll(\".pin\")\n      .data(circlesData)\n      .enter()\n      .append(\"circle\", \".pin\")\n      .attr(\"r\", 4)\n      .attr(\"fill\", \"#007bff\")\n      .attr(\"transform\", function (d) {\n        return (\n          \"translate(\" +\n          projection([d.location.longitude, d.location.latitude]) +\n          \")\"\n        );\n      });\n    */\n    /*\n        svg\n          .select('.circles')\n          .selectAll('circle')\n          .data(circlesData, (d) => d.id)\n          .join((enter) => \n              enter\n                .append('circle')\n                .attr('transform', (d) => `translate(${path.centroid(d)})`)\n                .attr('fill-opacity', 0.5)\n            .style('cursor', 'pointer')\n            .attr('pointer-events', 'all')\n            .on('mouseenter', (d) => {\n              setRegionHighlighted({\n                stateCode: CITY_CODES[d.id],\n                districtName: d.properties.NAME_1 || UNKNOWN_DISTRICT_KEY,\n              });\n            })\n            .on('click', () => {\n              event.stopPropagation();\n            })\n          )\n          .transition(t)\n          .attr('fill', COLORS[statistic] + '70')\n          .attr('stroke', COLORS[statistic] + '70')\n          .attr('r', (d) => mapScale(d.value)\n        );\n        */"],"sourceRoot":""}